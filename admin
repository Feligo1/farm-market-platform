<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard â€” Farm Market Platform Zambia</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.5.0/chart.umd.min.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; }
    body { background: #f6f7fb; color: #333; }

    header {
      background: linear-gradient(90deg, #006400, #ff6700, #000000);
      color: white;
      padding: 15px 0;
      text-align: center;
      font-size: 1.8rem;
      font-weight: 600;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    nav {
      background: #004d26;
      display: flex;
      justify-content: center;
      padding: 10px;
      gap: 30px;
    }
    nav a {
      color: white;
      text-decoration: none;
      font-weight: 500;
      transition: 0.3s;
    }
    nav a:hover { color: orange; }

    .container {
      width: 90%;
      max-width: 1200px;
      margin: 30px auto;
      background: white;
      border-radius: 12px;
      padding: 25px 30px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    h2 { color: #006400; margin-bottom: 10px; }
    hr { border: none; border-top: 1px solid #ddd; margin: 20px 0; }

    .summary {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      gap: 20px;
      margin-bottom: 25px;
    }
    .card {
      flex: 1;
      min-width: 230px;
      padding: 20px;
      border-radius: 10px;
      color: white;
      text-align: center;
      font-weight: bold;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }
    .green { background: #006400; }
    .orange { background: #ff6700; }
    .black { background: #000; }
    .red { background: #b30000; }

    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    input, select, button {
      padding: 10px 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 0.95rem;
    }
    button {
      background: #006400;
      color: white;
      cursor: pointer;
      font-weight: 500;
      transition: 0.2s;
    }
    button:hover { background: #004d26; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 0.9rem;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: center;
    }
    th { background: #006400; color: white; }

    canvas { margin: 25px 0; max-width: 100%; }

    footer {
      text-align: center;
      padding: 15px;
      background: #004d26;
      color: white;
      margin-top: 40px;
      font-size: 0.85rem;
    }

    .logout-btn {
      float: right;
      background: red;
      border: none;
      color: white;
      padding: 8px 15px;
      border-radius: 8px;
      cursor: pointer;
    }
    .logout-btn:hover { background: darkred; }
  </style>
</head>
<body>
  <header>ðŸŒ¾ Admin Dashboard â€” Zambia Farm Market</header>
  <nav>
    <a href="index.html">Farmer View</a>
    <a href="#" onclick="downloadReport()">ðŸ“„ Download PDF Report</a>
    <a href="#" onclick="logout()">ðŸšª Logout</a>
  </nav>

  <div class="container">
    <h2>ðŸ“Š Market Overview</h2>
    <hr>
    <section class="summary">
      <div class="card green"><h3>Total Records</h3><p id="totalRecords">0</p></div>
      <div class="card orange"><h3>Average Maize (ZMW)</h3><p id="avgMaize">0</p></div>
      <div class="card red"><h3>Average Tomato (ZMW)</h3><p id="avgTomato">0</p></div>
      <div class="card black"><h3>Total Markets</h3><p id="totalMarkets">0</p></div>
    </section>

    <div class="controls">
      <input type="text" id="commodity" placeholder="Commodity e.g., Maize">
      <button onclick="loadPrices()">Load Data</button>
      <button onclick="getForecast()">Forecast 3 Days</button>
    </div>

    <canvas id="chartCanvas" height="100"></canvas>

    <table id="priceTable">
      <thead>
        <tr><th>Date</th><th>Market</th><th>Commodity</th><th>Price (ZMW)</th><th>Volume</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <hr>
    <h2>âž• Add New Record</h2>
    <div class="controls">
      <input type="text" id="newMarket" placeholder="Market">
      <input type="text" id="newCommodity" placeholder="Commodity">
      <input type="number" id="newPrice" placeholder="Price">
      <input type="number" id="newVolume" placeholder="Volume">
      <button onclick="addPrice()">Add Record</button>
    </div>
  </div>

  <footer>Â© 2025 Mulungushi University | Developed by Tech Guy | Supervised by Mr. Nyirenda</footer>

  <script>
    const API_BASE = "http://127.0.0.1:5000/api";
    let chart = null;

    function logout() { window.location.href = "login.html"; }

    async function loadSummary() {
      const res = await fetch(`${API_BASE}/prices`);
      const json = await res.json();
      if (json.status !== "ok") return;

      const data = json.data;
      document.getElementById("totalRecords").innerText = data.length;

      const maize = data.filter(r => r.commodity === "Maize").map(r => r.price);
      const tomato = data.filter(r => r.commodity === "Tomatoes").map(r => r.price);
      const avg = arr => arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(2) : 0;

      document.getElementById("avgMaize").innerText = avg(maize);
      document.getElementById("avgTomato").innerText = avg(tomato);
      document.getElementById("totalMarkets").innerText = new Set(data.map(r=>r.market)).size;
    }

    async function loadPrices() {
      const commodity = document.getElementById("commodity").value || "Maize";
      const res = await fetch(`${API_BASE}/prices?commodity=${commodity}`);
      const json = await res.json();
      const tbody = document.querySelector("#priceTable tbody");
      tbody.innerHTML = "";
      const dates = [], prices = [];

      json.data.forEach(r => {
        tbody.innerHTML += `<tr><td>${r.recorded_at}</td><td>${r.market}</td><td>${r.commodity}</td><td>${r.price}</td><td>${r.volume}</td></tr>`;
        dates.push(r.recorded_at); prices.push(r.price);
      });

      drawChart(dates, prices, commodity);
    }

    async function getForecast() {
      const commodity = document.getElementById("commodity").value || "Maize";
      const res = await fetch(`${API_BASE}/forecast?commodity=${commodity}&days=3`);
      const json = await res.json();
      alert(json.status === "ok" ? JSON.stringify(json.predictions, null, 2) : "No forecast available.");
    }

    async function addPrice() {
      const body = {
        market: document.getElementById("newMarket").value,
        commodity: document.getElementById("newCommodity").value,
        price: document.getElementById("newPrice").value,
        volume: document.getElementById("newVolume").value
      };
      const res = await fetch(`${API_BASE}/add-price`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(body)
      });
      const json = await res.json();
      alert(json.message || "Record added.");
      loadPrices();
    }

    function downloadReport() { window.open(`${API_BASE}/report`, "_blank"); }

    function drawChart(dates, prices, label) {
      const ctx = document.getElementById("chartCanvas").getContext("2d");
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: dates,
          datasets: [{
            label,
            data: prices,
            borderColor: "#ff6700",
            backgroundColor: "rgba(255,103,0,0.15)",
            tension: 0.3,
            fill: true
          }]
        },
        options: { scales: { y: { beginAtZero: false } } }
      });
    }

    loadSummary();
    loadPrices();
  </script>
</body>
</html>
